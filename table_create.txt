CREATE TABLE AUTHOR
(
    b_id INTEGER NOT NULL,
    name_id INTEGER NOT NULL,
    PRIMARY KEY (b_id, name_id),
    FOREIGN KEY (b_id) REFERENCES ISBN (b_id) DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY (name_id) REFERENCES NAMES (id) DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE BOOK
(
    b_id INTEGER PRIMARY KEY NOT NULL,
    title TEXT NOT NULL,
    pid INTEGER NOT NULL,
    year INTEGER,
    price REAL,
    cid INTEGER NOT NULL,
    FOREIGN KEY (b_id) REFERENCES ISBN (b_id) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY (pid) REFERENCES PUBLISHERS (pid) DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY (cid) REFERENCES CATEGORY (c_id) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE CATEGORY
(
    c_id INTEGER PRIMARY KEY NOT NULL,
    category TEXT
);
CREATE TABLE CUSTOMER
(
    entity_id INTEGER PRIMARY KEY NOT NULL,
    FOREIGN KEY (entity_id) REFERENCES ENTITY (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE ENTITY
(
    id INTEGER PRIMARY KEY NOT NULL,
    name_id INTEGER,
    phone INTEGER,
    email TEXT,
    country TEXT,
    city TEXT,
    state TEXT,
    postalcode INTEGER,
    address TEXT,
    FOREIGN KEY (name_id) REFERENCES NAMES (id) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE INVENTORY
(
    bid INTEGER NOT NULL,
    wid INTEGER PRIMARY KEY NOT NULL,
    quantity INTEGER,
    sold INTEGER DEFAULT 0,
    FOREIGN KEY (bid) REFERENCES ISBN (b_id) DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY (wid) REFERENCES WAREHOUSE (wid) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE ISBN
(
    b_id INTEGER PRIMARY KEY,
    ISBN INTEGER NOT NULL
);
CREATE TABLE NAMES
(
    id INTEGER PRIMARY KEY NOT NULL,
    fname TEXT,
    lname TEXT,
    mname TEXT
);
CREATE TABLE ORDERITEM
(
    id INTEGER PRIMARY KEY NOT NULL,
    order_id INTEGER NOT NULL,
    bid INTEGER NOT NULL,
    quantity INTEGER DEFAULT 1 NOT NULL,
    timestamp TEXT,
    FOREIGN KEY (order_id) REFERENCES ORDER_TRANSACTION (order_id) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED,
    FOREIGN KEY (bid) REFERENCES ISBN (b_id) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE ORDER_TRANSACTION
(
    order_id INTEGER PRIMARY KEY NOT NULL,
    customer_id INTEGER NOT NULL,
    FOREIGN KEY (customer_id) REFERENCES CUSTOMER (entity_id) DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE PUBLISHERS
(
    pid INTEGER PRIMARY KEY NOT NULL,
    publisher TEXT NOT NULL
);
CREATE TABLE RATING
(
    b_id INTEGER PRIMARY KEY NOT NULL,
    RATING REAL DEFAULT 0 NOT NULL,
    FOREIGN KEY (b_id) REFERENCES ISBN (b_id) ON DELETE CASCADE ON UPDATE CASCADE DEFERRABLE INITIALLY DEFERRED
);
CREATE TABLE WAREHOUSE
(
    wid INTEGER PRIMARY KEY NOT NULL,
    wlocation TEXT NOT NULL
);

CREATE VIEW [Inventory Info For All Books] AS
SELECT J.ISBN, B.title, K.quantity
FROM BOOK AS B , (SELECT DISTINCT I.bid, SUM(I.quantity) AS quantity
            FROM INVENTORY AS I
            GROUP BY I.bid) AS K, ISBN AS J
WHERE B.b_id = K.bid AND
  J.b_id = B.b_id

CREATE VIEW [Top 5 Best Sellers] AS
   SELECT B.title, K.lname, K.fname, C.category,R.RATING, SUM(OI.quantity) AS t_quantity
FROM BOOK AS B, ORDERITEM AS OI, CATEGORY AS C, RATING AS R ,(SELECT A.b_id, N.lname, N.fname
   FROM NAMES AS N, AUTHOR AS A, BOOK AS B
   WHERE A.b_id=B.b_id AND A.name_id = N.id
   GROUP BY A.b_id) AS K
WHERE (B.b_id=OI.bid AND B.cid=C.c_id AND B.b_id=R.b_id AND B.b_id=K.b_id)
GROUP BY B.title
ORDER BY t_quantity DESC
LIMIT 5

CREATE VIEW [Top 5 Customers] AS
 	  SELECT K.entity_id AS C_ID, N.lname, N.fname, K.num_purchased
FROM (SELECT C.entity_id, COUNT(OT.customer_id) AS num_purchased
FROM CUSTOMER AS C, ORDER_TRANSACTION AS OT
WHERE (C.entity_id = OT.customer_id)
GROUP BY C.entity_id
ORDER BY num_purchased DESC) AS K, NAMES AS N
WHERE K.entity_id = N.id
LIMIT 5

CREATE UNIQUE INDEX sqlite_autoindex_INVENTORY_1 ON INVENTORY (bid, wid);
CREATE UNIQUE INDEX PUBLISHERS_publisher_uindex ON PUBLISHERS (publisher);

